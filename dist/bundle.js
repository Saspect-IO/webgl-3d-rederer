(()=>{"use strict";function t(t,r,e,i){return new(e||(e=Promise))((function(o,n){function a(t){try{u(i.next(t))}catch(t){n(t)}}function s(t){try{u(i.throw(t))}catch(t){n(t)}}function u(t){var r;t.done?o(t.value):(r=t.value,r instanceof e?r:new e((function(t){t(r)}))).then(a,s)}u((i=i.apply(t,r||[])).next())}))}function r(t,r){var e,i,o,n,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return n={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function s(n){return function(s){return function(n){if(e)throw new TypeError("Generator is already executing.");for(;a;)try{if(e=1,i&&(o=2&n[0]?i.return:n[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,n[1])).done)return o;switch(i=0,o&&(n=[2&n[0],o.value]),n[0]){case 0:case 1:o=n;break;case 4:return a.label++,{value:n[1],done:!1};case 5:a.label++,i=n[1],n=[0];continue;case 7:n=a.ops.pop(),a.trys.pop();continue;default:if(!((o=(o=a.trys).length>0&&o[o.length-1])||6!==n[0]&&2!==n[0])){a=0;continue}if(3===n[0]&&(!o||n[1]>o[0]&&n[1]<o[3])){a.label=n[1];break}if(6===n[0]&&a.label<o[1]){a.label=o[1],o=n;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(n);break}o[2]&&a.ops.pop(),a.trys.pop();continue}n=r.call(t,a)}catch(t){n=[6,t],i=0}finally{e=o=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,s])}}}var e,i,o,n,a,s;!function(t){t.WEBGL_CANVAS_ID="qrius-glCanvas",t.WEBGL_CONTEXT="webgl2",t.WEBGL_CONTEXT_EXPERIMENTAL="experimental-webgl",t.WEBGL_CONTEXT_WEBKIT="webkit-3d",t.WEBGL_CONTEXT_MOZ="moz-webgl",t.WEBGL_DEPTH_TEXTURE="WEBGL_depth_texture",t.WEBGL_CONTEXT_ERROR_MESSAGE="Could not initialise WebGL",t.WEBGL_DEPTH_TEXTUR_ERROR_MESSAGE="need WEBGL_depth_texture",t.PATH_ASSETS_OBJ="/formula_1.obj",t.PATH_ASSETS_TEXTURE="/formula_1.png",t[t.DEPTH_TEXTURE_SIZE=512]="DEPTH_TEXTURE_SIZE"}(e||(e={})),function(t){t[t.NEAR_PLANE=.1]="NEAR_PLANE",t[t.FAR_PLANE=100]="FAR_PLANE",t[t.FIELD_OF_VIEW=45]="FIELD_OF_VIEW",t[t.MODE_FREE=0]="MODE_FREE",t[t.MODE_ORBIT=1]="MODE_ORBIT"}(i||(i={})),function(t){t.KEY_DOWN_EVENT="keydown",t.KEY_UP_EVENT="keyup",t[t.KEY_DOWN=40]="KEY_DOWN",t[t.KEY_UP=38]="KEY_UP",t[t.KEY_LEFT=37]="KEY_LEFT",t[t.KEY_RIGHT=39]="KEY_RIGHT",t.MOUSE_UP="mouseup",t.MOUSE_DOWN="mousedown",t.MOUSE_WHEEL="mousewheel",t.MOUSE_MOVE="mousemove",t[t.ROTATION_RATE=-300]="ROTATION_RATE",t[t.PAN_RATE=5]="PAN_RATE",t[t.ZOOM_RATE=200]="ZOOM_RATE"}(o||(o={})),function(t){t[t.DEFAULT_OFFSET=0]="DEFAULT_OFFSET",t[t.DEFAULT_STRIDE=0]="DEFAULT_STRIDE",t.ATTR_POSITION_NAME="a_position",t.ATTR_NORMAL_NAME="a_norm",t.ATTR_UV_NAME="a_texCoord",t.UNI_COLOR="u_color",t[t.ATTR_UV_LOC=2]="ATTR_UV_LOC",t[t.GRID_VECTOR_SIZE=3]="GRID_VECTOR_SIZE",t[t.GRID_COLOR_SIZE=1]="GRID_COLOR_SIZE",t[t.GRID_VERTEX_LEN=4]="GRID_VERTEX_LEN",t.UNI_MODEL_MAT="u_mVMatrix",t.UNI_PERSPECTIV_MAT="u_pMatrix",t.UNI_ORTHO_MAT="u_oMatrix",t.UNI_CAMERA_MAT="u_cameraViewMatrix",t.UNI_LIGHT_VIEW_CAMERA_MAT="u_lightViewCameraMatrix",t.UNI_REVERSE_LIGHT_DIRECTION_MAT="u_reverseLightDirection",t.UNI_TEXTURE_MAT="u_textureMatrix",t.UNI_DIFFUSE="u_diffuse",t.UNI_PROJECTED_TEXTURE="u_projectedTexture",t.UNI_LIGHT_AMBIENT="u_ambientLightColor",t.UNI_LIGHT_DIRECTION="u_lightDirection",t.UNI_LIGHT_POSITION="u_lightPosition",t.UNI_CAMERA_POSITION="u_cameraPosition",t.UNI_CAMERA_SHININESS="u_shininess",t.UNI_LIGHT_COLOR="u_lightColor",t.UNI_SPECULAR_COLOR="u_specularColor",t.UNI_SPECULAR_FACTOR="u_specularFactor",t.BUFFER_TYPE_INDICES="indices",t.BUFFER_TYPE_VERTICES="vertices"}(n||(n={})),function(t){t.CAMERA_MATRIX="cameraMatrix",t.MODEL_MATRIX="modelViewMatrix",t.PERSPECTIVE_MATRIX="perspectiveMatrix",t.ORTHO_MATRIX="orthoMatrix"}(a||(a={})),function(t){t.V="v",t.VN="vn",t.VT="vt",t.F="f"}(s||(s={}));var u=/\s+/,c=function(t){return{vertices:t}},h=function(t,r,e){return{position:t,normal:r,uv:e}},l=function(t,r,e){return{x:t,y:r,z:e}},f=function(t){return t*Math.PI/180},_=function(t){var r=[t.red/255,t.green/255,t.blue/255,1];return new Float32Array(r)};const p=function(){function t(t){var r,i,o,n,a,s,u;this.gl=null,this.rgb_32_bit=255,this.alpha=1;var c=document.getElementById(t);this.gl=c.getContext(e.WEBGL_CONTEXT),null!==(r=this.gl)&&void 0!==r||alert(e.WEBGL_CONTEXT_ERROR_MESSAGE),null===(i=this.gl)||void 0===i||i.cullFace(this.gl.BACK),null===(o=this.gl)||void 0===o||o.frontFace(this.gl.CCW),null===(n=this.gl)||void 0===n||n.enable(this.gl.DEPTH_TEST),null===(a=this.gl)||void 0===a||a.enable(this.gl.CULL_FACE),null===(s=this.gl)||void 0===s||s.depthFunc(this.gl.LEQUAL),null===(u=this.gl)||void 0===u||u.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.canvas=c}return t.prototype.setSize=function(t,r){var e;return this.canvas.style.width=t+"px",this.canvas.style.height=r+"px",this.canvas.width=t,this.canvas.height=r,null===(e=this.gl)||void 0===e||e.viewport(0,0,t,r),this},t.prototype.depthRender=function(t){var r,e,i;return null===(r=this.gl)||void 0===r||r.bindFramebuffer(null===(e=this.gl)||void 0===e?void 0:e.FRAMEBUFFER,t.depthFramebuffer),null===(i=this.gl)||void 0===i||i.viewport(0,0,t.depthTextureSize,t.depthTextureSize),this},t.prototype.fitScreen=function(t,r){return this.setSize(window.innerWidth*(t||1),window.innerHeight*(r||1))},t.prototype.setClearColor=function(t,r,e,i){var o;return void 0===i&&(i=1),null===(o=this.gl)||void 0===o||o.clearColor(t/this.rgb_32_bit,r/this.rgb_32_bit,e/this.rgb_32_bit,i),this},t.prototype.clearFramebuffer=function(){var t,r;return null===(t=this.gl)||void 0===t||t.bindFramebuffer(null===(r=this.gl)||void 0===r?void 0:r.FRAMEBUFFER,null),this},t.prototype.clear=function(){var t,r,e;return null===(t=this.gl)||void 0===t||t.clear((null===(r=this.gl)||void 0===r?void 0:r.COLOR_BUFFER_BIT)|(null===(e=this.gl)||void 0===e?void 0:e.DEPTH_BUFFER_BIT)),this},t.prototype.getContext=function(){return this.gl},t}();var m=function(){function t(t,r,e){this.x=t||0,this.y=r||0,this.z=e||0}return t.prototype.magnitude=function(t){if(void 0===t&&(t={x:0,y:0,z:0}),void 0===t)return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);var r=t.x-this.x,e=t.y-this.y,i=t.y-this.z;return Math.sqrt(r*r+e*e+i*i)},t.prototype.normalize=function(){var t=this.magnitude();return this.x/=t,this.y/=t,this.z/=t,this},t.prototype.set=function(t,r,e){return this.x=t,this.y=r,this.z=e,this},t.prototype.multiScalar=function(t){return this.x*=t,this.y*=t,this.z*=t,this},t.prototype.getArray=function(){return[this.x,this.y,this.z]},t.prototype.getFloatArray=function(){return new Float32Array([this.x,this.y,this.z])},t.prototype.clone=function(){return new t(this.x,this.y,this.z)},t}(),E=function(){function t(){this.matrix=t.identity()}return t.prototype.vtranslate=function(r){return t.translate(this.matrix,r.x,r.y,r.z),this},t.prototype.translate=function(r,e,i){return t.translate(this.matrix,r,e,i),this},t.prototype.rotateY=function(r){return t.rotateY(this.matrix,r),this},t.prototype.rotateX=function(r){return t.rotateX(this.matrix,r),this},t.prototype.rotateZ=function(r){return t.rotateZ(this.matrix,r),this},t.prototype.vscale=function(r){return t.scale(this.matrix,r.x,r.y,r.z),this},t.prototype.scale=function(r,e,i){return t.scale(this.matrix,r,e,i),this},t.prototype.invert=function(){return t.invert(this.matrix),this},t.prototype.resetRotation=function(){for(var t=0;t<this.matrix.length;t++)t>=12&&t<=14||(this.matrix[t]=t%5==0?1:0);return this},t.prototype.resetMat=function(){for(var t=0;t<this.matrix.length;t++)this.matrix[t]=t%5==0?1:0;return this},t.identity=function(){var t=new Float32Array(16);return t[0]=t[5]=t[10]=t[15]=1,t},t.perspective=function(t,r,e,i,o){var n=1/Math.tan(r/2),a=1/(i-o);t[0]=n/e,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=n,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=(o+i)*a,t[11]=-1,t[12]=0,t[13]=0,t[14]=2*o*i*a,t[15]=0},t.ortho=function(t,r,e,i,o,n,a){var s=1/(r-e),u=1/(i-o),c=1/(n-a);t[0]=-2*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*u,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*c,t[11]=0,t[12]=(r+e)*s,t[13]=(o+i)*u,t[14]=(a+n)*c,t[15]=1},t.lookAt=function(r,e,i,o){void 0===o&&(o=null),o=o||new Float32Array(16);var n=t.normalize(t.subtractVectors(r,e)),a=t.normalize(t.cross(i,n)),s=t.normalize(t.cross(n,a));return o[0]=a[0],o[1]=a[1],o[2]=a[2],o[3]=0,o[4]=s[0],o[5]=s[1],o[6]=s[2],o[7]=0,o[8]=n[0],o[9]=n[1],o[10]=n[2],o[11]=0,o[12]=r[0],o[13]=r[1],o[14]=r[2],o[15]=1,o},t.subtractVectors=function(t,r,e){return void 0===e&&(e=null),(e=e||new Float32Array(3))[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e},t.cross=function(t,r,e){return void 0===e&&(e=null),(e=e||new Float32Array(3))[0]=t[1]*r[2]-t[2]*r[1],e[1]=t[2]*r[0]-t[0]*r[2],e[2]=t[0]*r[1]-t[1]*r[0],e},t.normalize=function(t,r){void 0===r&&(r=null),r=r||new Float32Array(3);var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);return e>1e-5&&(r[0]=t[0]/e,r[1]=t[1]/e,r[2]=t[2]/e),r},t.transpose=function(t,r){if(t===r){var e=r[1],i=r[2],o=r[3],n=r[6],a=r[7],s=r[11];t[1]=r[4],t[2]=r[8],t[3]=r[12],t[4]=e,t[6]=r[9],t[7]=r[13],t[8]=i,t[9]=n,t[11]=r[14],t[12]=o,t[13]=a,t[14]=s}else t[0]=r[0],t[1]=r[4],t[2]=r[8],t[3]=r[12],t[4]=r[1],t[5]=r[5],t[6]=r[9],t[7]=r[13],t[8]=r[2],t[9]=r[6],t[10]=r[10],t[11]=r[14],t[12]=r[3],t[13]=r[7],t[14]=r[11],t[15]=r[15];return t},t.normalMat3=function(t,r){var e=r[0],i=r[1],o=r[2],n=r[3],a=r[4],s=r[5],u=r[6],c=r[7],h=r[8],l=r[9],f=r[10],_=r[11],p=r[12],m=r[13],E=r[14],v=r[15],d=e*s-i*a,T=e*u-o*a,M=e*c-n*a,x=i*u-o*s,R=i*c-n*s,g=o*c-n*u,A=h*m-l*p,L=h*E-f*p,P=h*v-_*p,w=l*E-f*m,U=l*v-_*m,I=f*v-_*E,F=d*I-T*U+M*w+x*P-R*L+g*A;return F?(F=1/F,t[0]=(s*I-u*U+c*w)*F,t[1]=(u*P-a*I-c*L)*F,t[2]=(a*U-s*P+c*A)*F,t[3]=(o*U-i*I-n*w)*F,t[4]=(e*I-o*P+n*L)*F,t[5]=(i*P-e*U-n*A)*F,t[6]=(m*g-E*R+v*x)*F,t[7]=(E*M-p*g-v*T)*F,t[8]=(p*R-m*M+v*d)*F,t):null},t.multiplyVector=function(t,r){var e=r[0],i=r[1],o=r[2],n=r[3],a=t[0],s=t[1],u=t[2],c=t[3],h=t[4],l=t[5],f=t[6],_=t[7],p=t[8],m=t[9],E=t[10],v=t[11];return[e*a+i*h+o*p+n*t[12],e*s+i*l+o*m+n*t[13],e*u+i*f+o*E+n*t[14],e*c+i*_+o*v+n*t[15]]},t.transformVec4=function(t,r,e){return t[0]=e[0]*r[0]+e[4]*r[1]+e[8]*r[2]+e[12]*r[3],t[1]=e[1]*r[0]+e[5]*r[1]+e[9]*r[2]+e[13]*r[3],t[2]=e[2]*r[0]+e[6]*r[1]+e[10]*r[2]+e[14]*r[3],t[3]=e[3]*r[0]+e[7]*r[1]+e[11]*r[2]+e[15]*r[3],t},t.mult=function(t,r,e){var i=r[0],o=r[1],n=r[2],a=r[3],s=r[4],u=r[5],c=r[6],h=r[7],l=r[8],f=r[9],_=r[10],p=r[11],m=r[12],E=r[13],v=r[14],d=r[15],T=e[0],M=e[1],x=e[2],R=e[3];return t[0]=T*i+M*s+x*l+R*m,t[1]=T*o+M*u+x*f+R*E,t[2]=T*n+M*c+x*_+R*v,t[3]=T*a+M*h+x*p+R*d,T=e[4],M=e[5],x=e[6],R=e[7],t[4]=T*i+M*s+x*l+R*m,t[5]=T*o+M*u+x*f+R*E,t[6]=T*n+M*c+x*_+R*v,t[7]=T*a+M*h+x*p+R*d,T=e[8],M=e[9],x=e[10],R=e[11],t[8]=T*i+M*s+x*l+R*m,t[9]=T*o+M*u+x*f+R*E,t[10]=T*n+M*c+x*_+R*v,t[11]=T*a+M*h+x*p+R*d,T=e[12],M=e[13],x=e[14],R=e[15],t[12]=T*i+M*s+x*l+R*m,t[13]=T*o+M*u+x*f+R*E,t[14]=T*n+M*c+x*_+R*v,t[15]=T*a+M*h+x*p+R*d,t},t.scale=function(t,r,e,i){return t[0]*=r,t[1]*=r,t[2]*=r,t[3]*=r,t[4]*=e,t[5]*=e,t[6]*=e,t[7]*=e,t[8]*=i,t[9]*=i,t[10]*=i,t[11]*=i,t},t.rotateY=function(t,r){var e=Math.sin(r),i=Math.cos(r),o=t[0],n=t[1],a=t[2],s=t[3],u=t[8],c=t[9],h=t[10],l=t[11];return t[0]=o*i-u*e,t[1]=n*i-c*e,t[2]=a*i-h*e,t[3]=s*i-l*e,t[8]=o*e+u*i,t[9]=n*e+c*i,t[10]=a*e+h*i,t[11]=s*e+l*i,t},t.rotateX=function(t,r){var e=Math.sin(r),i=Math.cos(r),o=t[4],n=t[5],a=t[6],s=t[7],u=t[8],c=t[9],h=t[10],l=t[11];return t[4]=o*i+u*e,t[5]=n*i+c*e,t[6]=a*i+h*e,t[7]=s*i+l*e,t[8]=u*i-o*e,t[9]=c*i-n*e,t[10]=h*i-a*e,t[11]=l*i-s*e,t},t.rotateZ=function(t,r){var e=Math.sin(r),i=Math.cos(r),o=t[0],n=t[1],a=t[2],s=t[3],u=t[4],c=t[5],h=t[6],l=t[7];return t[0]=o*i+u*e,t[1]=n*i+c*e,t[2]=a*i+h*e,t[3]=s*i+l*e,t[4]=u*i-o*e,t[5]=c*i-n*e,t[6]=h*i-a*e,t[7]=l*i-s*e,t},t.rotate=function(t,r,e){var i,o,n,a,s,u,c,h,l,f,_,p,m,E,v,d,T,M,x,R,g,A,L,P,w=e[0],U=e[1],I=e[2],F=Math.sqrt(w*w+U*U+I*I);if(Math.abs(F)<1e-6)return null;w*=F=1/F,U*=F,I*=F,i=Math.sin(r),n=1-(o=Math.cos(r)),a=t[0],s=t[1],u=t[2],c=t[3],h=t[4],l=t[5],f=t[6],_=t[7],p=t[8],m=t[9],E=t[10],v=t[11],d=w*w*n+o,T=U*w*n+I*i,M=I*w*n-U*i,x=w*U*n-I*i,R=U*U*n+o,g=I*U*n+w*i,A=w*I*n+U*i,L=U*I*n-w*i,P=I*I*n+o,t[0]=a*d+h*T+p*M,t[1]=s*d+l*T+m*M,t[2]=u*d+f*T+E*M,t[3]=c*d+_*T+v*M,t[4]=a*x+h*R+p*g,t[5]=s*x+l*R+m*g,t[6]=u*x+f*R+E*g,t[7]=c*x+_*R+v*g,t[8]=a*A+h*L+p*P,t[9]=s*A+l*L+m*P,t[10]=u*A+f*L+E*P,t[11]=c*A+_*L+v*P},t.invert=function(t,r){void 0===r&&(r=t);var e=r[0],i=r[1],o=r[2],n=r[3],a=r[4],s=r[5],u=r[6],c=r[7],h=r[8],l=r[9],f=r[10],_=r[11],p=r[12],m=r[13],E=r[14],v=r[15],d=e*s-i*a,T=e*u-o*a,M=e*c-n*a,x=i*u-o*s,R=i*c-n*s,g=o*c-n*u,A=h*m-l*p,L=h*E-f*p,P=h*v-_*p,w=l*E-f*m,U=l*v-_*m,I=f*v-_*E,F=d*I-T*U+M*w+x*P-R*L+g*A;return!!F&&(F=1/F,t[0]=(s*I-u*U+c*w)*F,t[1]=(o*U-i*I-n*w)*F,t[2]=(m*g-E*R+v*x)*F,t[3]=(f*R-l*g-_*x)*F,t[4]=(u*P-a*I-c*L)*F,t[5]=(e*I-o*P+n*L)*F,t[6]=(E*M-p*g-v*T)*F,t[7]=(h*g-f*M+_*T)*F,t[8]=(a*U-s*P+c*A)*F,t[9]=(i*P-e*U-n*A)*F,t[10]=(p*R-m*M+v*d)*F,t[11]=(l*M-h*R-_*d)*F,t[12]=(s*L-a*w-u*A)*F,t[13]=(e*w-i*L+o*A)*F,t[14]=(m*T-p*x-E*d)*F,t[15]=(h*x-l*T+f*d)*F,!0)},t.translate=function(t,r,e,i){t[12]=t[0]*r+t[4]*e+t[8]*i+t[12],t[13]=t[1]*r+t[5]*e+t[9]*i+t[13],t[14]=t[2]*r+t[6]*e+t[10]*i+t[14],t[15]=t[3]*r+t[7]*e+t[11]*i+t[15]},t}();const v=function(){function t(){this.position=new m(0,0,0),this.scale=new m(1,1,1),this.rotation=new m(0,0,0),this.matView=new E,this.matNormal=new Float32Array(9),this.forward=new Float32Array(4),this.up=new Float32Array(4),this.right=new Float32Array(4)}return t.prototype.updateMatrix=function(){return this.matView.resetMat().vtranslate(this.position).rotateX(f(this.rotation.x)).rotateY(f(this.rotation.y)).rotateZ(f(this.rotation.z)).vscale(this.scale),E.normalMat3(this.matNormal,this.matView.matrix),E.transformVec4(this.forward,[0,0,1,0],this.matView.matrix),E.transformVec4(this.up,[0,1,0,0],this.matView.matrix),E.transformVec4(this.right,[1,0,0,0],this.matView.matrix),this.matView.matrix},t.prototype.updateDirection=function(){return E.transformVec4(this.forward,[0,0,1,0],this.matView.matrix),E.transformVec4(this.up,[0,1,0,0],this.matView.matrix),E.transformVec4(this.right,[1,0,0,0],this.matView.matrix),this},t.prototype.getModelMatrix=function(){return this.matView.matrix},t.prototype.getNormalMatrix=function(){return this.matNormal},t.prototype.reset=function(){this.position.set(0,0,0),this.scale.set(1,1,1),this.rotation.set(0,0,0)},t}();var d=function(){function t(r,e,o,n){void 0===e&&(e=i.FIELD_OF_VIEW),void 0===o&&(o=i.NEAR_PLANE),void 0===n&&(n=i.FAR_PLANE),this.perspectiveProjection=new Float32Array(16),this.orthoProjection=new Float32Array(16);var a=r.canvas.width/r.canvas.height,s=-r.canvas.width/2,u=r.canvas.width/2,c=r.canvas.height/2,h=-r.canvas.height/2;E.perspective(this.perspectiveProjection,e,a,o,n),E.ortho(this.orthoProjection,s,u,h,c,1,10),this.transform=new v,this.viewMatrix=new Float32Array(16),this.mode=t.MODE_ORBIT}return t.prototype.panX=function(r){this.mode!=t.MODE_ORBIT&&(this.updateViewMatrix(),this.transform.position.x+=this.transform.right[0]*r,this.transform.position.y+=this.transform.right[1]*r,this.transform.position.z+=this.transform.right[2]*r)},t.prototype.panY=function(r){this.updateViewMatrix(),this.transform.position.y+=this.transform.up[1]*r,this.mode!=t.MODE_ORBIT&&(this.transform.position.x+=this.transform.up[0]*r,this.transform.position.z+=this.transform.up[2]*r)},t.prototype.panZ=function(r){this.updateViewMatrix(),this.mode==t.MODE_ORBIT?this.transform.position.z+=r:(this.transform.position.x+=this.transform.forward[0]*r,this.transform.position.y+=this.transform.forward[1]*r,this.transform.position.z+=this.transform.forward[2]*r)},t.prototype.updateViewMatrix=function(){return this.mode==t.MODE_FREE?this.transform.matView.resetMat().vtranslate(this.transform.position).rotateX(f(this.transform.rotation.x)).rotateY(f(this.transform.rotation.y)):this.transform.matView.resetMat().rotateX(f(this.transform.rotation.x)).rotateY(f(this.transform.rotation.y)).vtranslate(this.transform.position),this.transform.updateDirection(),E.invert(this.viewMatrix,this.transform.matView.matrix),this.viewMatrix},t.MODE_FREE=i.MODE_FREE,t.MODE_ORBIT=i.MODE_ORBIT,t}(),T=function(){function t(t,r){var e=this,i=t.canvas.getBoundingClientRect();this.canvas=t.canvas,this.camera=r,this.rotateRate=o.ROTATION_RATE,this.panRate=o.PAN_RATE,this.zoomRate=o.ZOOM_RATE,this.offsetX=i.left,this.offsetY=i.top,this.initX=0,this.initY=0,this.prevX=0,this.prevY=0,this.onUpHandler=function(t){return e.onMouseUp(t)},this.onMoveHandler=function(t){return e.onMouseMove(t)},this.canvas.addEventListener(o.MOUSE_DOWN,(function(t){return e.onMouseDown(t)})),this.canvas.addEventListener(o.MOUSE_WHEEL,(function(t){return e.onMouseWheel(t)}))}return t.prototype.getMouseVec2=function(t){return{x:t.pageX-this.offsetX,y:t.pageY-this.offsetY}},t.prototype.onMouseDown=function(t){this.initX=this.prevX=t.pageX-this.offsetX,this.initY=this.prevY=t.pageY-this.offsetY,this.canvas.addEventListener(o.MOUSE_UP,this.onUpHandler),this.canvas.addEventListener(o.MOUSE_MOVE,this.onMoveHandler)},t.prototype.onMouseUp=function(t){this.canvas.removeEventListener(o.MOUSE_UP,this.onUpHandler),this.canvas.removeEventListener(o.MOUSE_MOVE,this.onMoveHandler)},t.prototype.onMouseWheel=function(t){var r=Math.max(-1,Math.min(1,t.wheelDelta||-t.detail));this.camera.panZ(-r*(this.zoomRate/this.canvas.height))},t.prototype.onMouseMove=function(t){var r=t.pageX-this.offsetX,e=t.pageY-this.offsetY,i=r-this.prevX,o=e-this.prevY;t.shiftKey?(this.camera.panX(-i*(this.panRate/this.canvas.width)),this.camera.panY(o*(this.panRate/this.canvas.height))):(this.camera.transform.rotation.y+=i*(this.rotateRate/this.canvas.width),this.camera.transform.rotation.x+=o*(this.rotateRate/this.canvas.height)),this.prevX=r,this.prevY=e},t}();const M=function(){function t(t){this.mesh=t,this.transform=new v}return t.prototype.setScale=function(t,r,e){return this.transform.scale.set(t,r,e),this},t.prototype.setPosition=function(t,r,e){return this.transform.position.set(t,r,e),this},t.prototype.setRotation=function(t,r,e){return this.transform.rotation.set(t,r,e),this},t.prototype.addScale=function(t,r,e){return this.transform.scale.x+=t,this.transform.scale.y+=r,this.transform.scale.y+=r,this},t.prototype.addPosition=function(t,r,e){return this.transform.position.x+=t,this.transform.position.y+=r,this.transform.position.z+=e,this},t.prototype.addRotation=function(t,r,e){return this.transform.rotation.x+=t,this.transform.rotation.y+=r,this.transform.rotation.z+=e,this},t.prototype.preRender=function(){return this.transform.updateMatrix(),this},t}(),x=function(){function t(t,r){var e=t.createTexture();t.bindTexture(t.TEXTURE_2D,e),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.generateMipmap(t.TEXTURE_2D),this.gl=t}return t.loadTexture=function(r,e){return new Promise((function(i){var o=new Image;o.onload=function(){i(new t(r,o))},o.src=e}))},t}(),R=function(){function t(t,r,e,i){switch(this.buffer=t.createBuffer(),i){case n.BUFFER_TYPE_VERTICES:t.bindBuffer(t.ARRAY_BUFFER,this.buffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(r),t.STATIC_DRAW);break;case n.BUFFER_TYPE_INDICES:t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.buffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(r),t.STATIC_DRAW);break;default:t.bindBuffer(t.ARRAY_BUFFER,this.buffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(r),t.STATIC_DRAW)}this.gl=t,this.size=r.length/e}return t.prototype.destroy=function(){this.gl.deleteBuffer(this.buffer)},t.prototype.bindToAttribute=function(t,r,e,i,o){void 0===i&&(i=this.size),void 0===o&&(o=n.BUFFER_TYPE_VERTICES);var a=this.gl;switch(o){case n.BUFFER_TYPE_VERTICES:a.enableVertexAttribArray(t),a.bindBuffer(a.ARRAY_BUFFER,this.buffer),a.vertexAttribPointer(t,i,a.FLOAT,!1,r,e),a.bindBuffer(a.ARRAY_BUFFER,null);break;case n.BUFFER_TYPE_INDICES:a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.buffer),a.bufferData(a.ELEMENT_ARRAY_BUFFER,new Uint16Array(t),a.STATIC_DRAW),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null);break;default:a.enableVertexAttribArray(t),a.bindBuffer(a.ARRAY_BUFFER,this.buffer),a.vertexAttribPointer(t,i,a.FLOAT,!1,r,e),a.bindBuffer(a.ARRAY_BUFFER,null)}},t}(),g=function(){function t(t,r,e){this.gl=null,this.vertexShader=null,this.fragmentShader=null;var i=this.createShader(t,t.VERTEX_SHADER,r),o=this.createShader(t,t.FRAGMENT_SHADER,e),n=this.createShaderProgram(t,o,i);this.program=n,this.gl=t}return t.prototype.createShader=function(t,r,e){var i=t.createShader(r);return t.shaderSource(i,e),t.compileShader(i),t.getShaderParameter(i,t.COMPILE_STATUS)?i:(console.error("An error occurred compiling the shaders: "+t.getShaderInfoLog(i)),t.deleteShader(i),null)},t.prototype.createShaderProgram=function(t,r,e){var i=t.createProgram();if(t.attachShader(i,r),t.attachShader(i,e),t.linkProgram(i),!t.getProgramParameter(i,t.LINK_STATUS))throw console.error("Error creating shader program.",t.getProgramInfoLog(i)),t.deleteProgram(i),new Error("Failed to link shaderProgram");return this.vertexShader=r,this.fragmentShader=e,t.detachShader(i,r),t.detachShader(i,e),t.deleteShader(e),t.deleteShader(r),i},t.prototype.activateShader=function(){return this.gl.useProgram(this.program),this},t.prototype.deactivateShader=function(){return this.gl.useProgram(null),this},t.prototype.dispose=function(){this.gl.getParameter(this.gl.CURRENT_PROGRAM)===this.program&&this.deactivateShader(),this.gl.deleteProgram(this.program)},t.prototype.renderModel=function(t){var r=this.gl;return t.mesh.noCulling&&r.disable(r.CULL_FACE),t.mesh.doBlending&&r.enable(r.BLEND),r.drawArrays(t.mesh.drawMode,0,t.mesh.vertexCount),t.mesh.noCulling&&r.enable(r.CULL_FACE),t.mesh.doBlending&&r.disable(r.BLEND),this},t}(),A=function(){function e(t){this.surfaces=[],this.surfaces=t}return e.parseOBJ=function(i){return t(this,void 0,void 0,(function(){var t,o,n,a,f,_,p,m,E,v,d,T,M,x,R,g,A,L,P,w,U,I,F,y,S;return r(this,(function(r){for(t=s.V,o=s.VN,n=s.VT,a=s.F,f=i.split("\n"),_=[],p=[],m=[],E=[],v=0,d=f;v<d.length;v++)if(T=d[v],M=T.trim().split(u),x=M[0],t===x)_.push(l(parseFloat(M[1]),parseFloat(M[2]),parseFloat(M[3])));else if(o===x)m.push(l(parseFloat(M[1]),parseFloat(M[2]),parseFloat(M[3])));else if(n===x)p.push({x:parseFloat(M[1]),y:1-parseFloat(M[2])});else if(a===x){for(R=!1,g=!1,A=4,L=[],P=1;P<A;P++){if(M.length>A&&!g)A+=1;else if(4!==P||R){if(5===P&&R)P=1,R=!1,g=!0;else if(2===P&&g)break}else P=3,A+=1,R=!0;w=M[P].split("/"),U=_[parseInt(w[0])-1],I=p[parseInt(w[1])-1],F=m[parseInt(w[2])-1],L.push(h(U,F,I))}L.length>3?(y=L.slice(0,3),S=L.slice(3),E.push(c(y)),E.push(c(S))):E.push(c(L))}return[2,new e(E)]}))}))},e.loadOBJ=function(i){return t(this,void 0,void 0,(function(){var t;return r(this,(function(r){switch(r.label){case 0:return[4,fetch(i)];case 1:return[4,r.sent().text()];case 2:return t=r.sent(),[4,Promise.all([e.parseOBJ(t)])];case 3:return[2,r.sent()[0]]}}))}))},e.prototype.vertexCount=function(){return 3*this.surfaces.length},e.prototype.positions=function(){var t=[];return this.surfaces.forEach((function(r){r.vertices.forEach((function(r){var e=r.position;t.push(e.x,e.y,e.z)}))})),t},e.prototype.normals=function(){var t=[];return this.surfaces.forEach((function(r){r.vertices.forEach((function(r){var e=r.normal;t.push(e.x,e.y,e.z)}))})),t},e.prototype.uvs=function(){var t=[];return this.surfaces.forEach((function(r){r.vertices.forEach((function(r){var e=r.uv;t.push(e.x,e.y)}))})),t},e}();var L=function(){function t(t,r,e){var i=new g(t,"#version 300 es\n\t\t\tin vec3 a_position;\n\t\t\tin vec3 a_norm;\n\t\t\tin vec2 a_texCoord;\n\n\t\t\tuniform vec3 u_lightPosition;\n\t\t\tuniform vec3 u_cameraPosition;\n\n\t\t\tuniform mat4 u_mVMatrix;\n\t\t\tuniform mat4 u_cameraViewMatrix;\n\t\t\tuniform mat4 u_pMatrix;\n\t\t\tuniform mat4 u_textureMatrix;\n\n\t\t\tmat4 m_worldMatrix;\n\t\t\tmat4 m_viewProjectionMatrix;\n\t\t\tmat4 m_worldViewProjectionMatrix;\n\t\t\tmat4 m_textureMatrix;\n\t\t\t\n\t\t\tout vec3 v_normal;\n\t\t\tout vec3 v_surfaceToLight;\n\t\t\tout vec3 v_surfaceToCamera;\n\n\t\t\tout vec2 v_texCoord;\n\t\t\tout vec4 v_projectedTexcoord;\n\n\t\t\tvoid main(void){\n\n\t\t\t\tm_worldMatrix = u_mVMatrix;\n\t\t\t\tm_viewProjectionMatrix = u_pMatrix * u_cameraViewMatrix;\n\t\t\t\tm_worldViewProjectionMatrix = m_viewProjectionMatrix * m_worldMatrix;\n\t\t\t\tm_textureMatrix = u_textureMatrix;\n\n\t\t\t\tgl_Position = m_worldViewProjectionMatrix * vec4(a_position, 1.0);\n\t\t\t\t\n\t\t\t\tv_normal = (u_cameraViewMatrix * vec4(a_norm, 0.0)).xyz;\n\n\t\t\t\tvec3 v_surfaceWorldPosition = (m_worldMatrix * vec4(a_position, 1.0)).xyz;\n\t\t\t\tv_surfaceToLight = u_lightPosition - v_surfaceWorldPosition;\n\t\t\t\tv_surfaceToCamera = u_cameraPosition - v_surfaceWorldPosition;\n\n\t\t\t\tv_texCoord = a_texCoord;\n\t\t\t\tv_projectedTexcoord = m_textureMatrix * vec4(v_surfaceWorldPosition, 1.0);\n\t\t\t}","#version 300 es\n\t\t\tprecision highp float;\n\n\t\t\tin vec2 v_texCoord;\n\t\t\tin vec4 v_projectedTexcoord;\n\t\t\tin vec3 v_normal;\n\t\t\tin vec3 v_surfaceToLight;\n\t\t\tin vec3 v_surfaceToCamera;\n\t\t\t\n\t\t\t\n\t\t\tuniform vec4 u_lightColor;\n\t\t\tuniform vec4 u_ambientLightColor;\n\t\t\tuniform sampler2D u_diffuse;\n\t\t\tuniform sampler2D u_projectedTexture;\n\t\t\tuniform vec4 u_specularColor;\n\t\t\tuniform float u_shininess;\n\t\t\tuniform float u_specularFactor;\n\t\t\tuniform float u_bias;\n\t\t\tuniform vec3 u_reverseLightDirection;\n\n\t\t\tvec4 lit(float l ,float h, float m) {\n\t\t\t\treturn vec4(\n\t\t\t\t\t1.0,\n\t\t\t\t\tabs(l),\n\t\t\t\t\t(l > 0.0) ? pow(max(0.0, h), m) : 0.0,\n\t\t\t\t\t1.0\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tout vec4 finalColor;\n\n\t\t\tvoid main(void) {\n\n\t\t\t\tvec3 normal = normalize(v_normal);\n\n\t\t\t\tfloat light = dot(normal, u_reverseLightDirection);\n\n\t\t\t\tvec3 projectedTexcoord = v_projectedTexcoord.xyz / v_projectedTexcoord.w;\n\t\t\t\tfloat currentDepth = projectedTexcoord.z + u_bias;\n\n\t\t\t\tbool inRange =+\n\t\t\t\t\tprojectedTexcoord.x >= 0.0 &&+\n\t\t\t\t\tprojectedTexcoord.x <= 1.0 &&+\n\t\t\t\t\tprojectedTexcoord.y >= 0.0 &&+\n\t\t\t\t\tprojectedTexcoord.y <= 1.0;\n\n\t\t\t\tfloat projectedDepth = texture(u_projectedTexture, projectedTexcoord.xy).r;\n\t\t\t\tfloat shadowLight = (inRange && projectedDepth <= currentDepth) ? 0.0 : 1.0;\n\n\t\t\t\tvec3 surfaceToLightDirection = normalize(v_surfaceToLight);\n\t\t\t\tvec3 surfaceToCameraDirection = normalize(v_surfaceToCamera);\n\t\t\t\tvec3 halfVector = normalize(surfaceToLightDirection + surfaceToCameraDirection);\n\n\n\t\t\t\tvec4 diffuseColor = texture(u_diffuse, v_texCoord);\n\t\t\t\tvec4 litR = lit(dot(normal, surfaceToLightDirection), dot(normal, halfVector), u_shininess);\n\t\t\t\t\n\t\t\t\tvec4 mult1 = diffuseColor * litR.y;\n\t\t\t\tvec4 mult2 = diffuseColor * u_ambientLightColor;\n\t\t\t\tvec4 mult3 = u_specularColor * litR.z * u_specularFactor;\n\t\t\t\tvec4 mult4 = u_lightColor * ( mult1 + mult2 + mult3);\n\n\t\t\t\tvec4 outColor = mult4 * vec4(\n\t\t\t\t\tdiffuseColor.rgb * light * shadowLight,\n\t\t\t\t\tdiffuseColor.a);\n\n\n\t\t\t\tfinalColor = outColor;\n\t\t\t}");i.activateShader(),this.positionLoc=t.getAttribLocation(i.program,n.ATTR_POSITION_NAME),this.texCoordLoc=t.getAttribLocation(i.program,n.ATTR_UV_NAME),this.normalLoc=t.getAttribLocation(i.program,n.ATTR_NORMAL_NAME),this.modelViewMatrixLoc=t.getUniformLocation(i.program,n.UNI_MODEL_MAT),this.perspectiveMatrixLoc=t.getUniformLocation(i.program,n.UNI_PERSPECTIV_MAT),this.cameraMatrixLoc=t.getUniformLocation(i.program,n.UNI_CAMERA_MAT),this.projectedTextureLoc=t.getUniformLocation(i.program,n.UNI_PROJECTED_TEXTURE),this.textureMatrixLoc=t.getUniformLocation(i.program,n.UNI_TEXTURE_MAT),this.reverseLightDirectionLoc=t.getUniformLocation(i.program,n.UNI_REVERSE_LIGHT_DIRECTION_MAT),this.diffuseLoc=t.getUniformLocation(i.program,n.UNI_DIFFUSE),this.ambientLightColorLoc=t.getUniformLocation(i.program,n.UNI_LIGHT_AMBIENT),this.lightPositionLoc=t.getUniformLocation(i.program,n.UNI_LIGHT_POSITION),this.cameraPositionLoc=t.getUniformLocation(i.program,n.UNI_CAMERA_POSITION),this.shininessLoc=t.getUniformLocation(i.program,n.UNI_CAMERA_SHININESS),this.lightColorLoc=t.getUniformLocation(i.program,n.UNI_LIGHT_COLOR),this.specularColorLoc=t.getUniformLocation(i.program,n.UNI_SPECULAR_COLOR),this.specularFactorLoc=t.getUniformLocation(i.program,n.UNI_SPECULAR_FACTOR),i.deactivateShader(),this.perspectiveProjectionMatrix=r.perspectiveProjection,this.orthoProjectionMatrix=r.orthoProjection,this.viewModelMatrix=r.viewMatrix,this.lightViewModelMatrix=e,this.shaderProgram=i}return t.prototype.setUniforms=function(t,r){this.shaderProgram.activateShader();var e=this.getLightWorldMatrix(this.lightViewModelMatrix,r);return t.uniformMatrix4fv(this.perspectiveMatrixLoc,!1,this.perspectiveProjectionMatrix),t.uniformMatrix4fv(this.cameraMatrixLoc,!1,this.viewModelMatrix),t.uniform3fv(this.reverseLightDirectionLoc,e.slice(8,11)),t.uniformMatrix4fv(this.textureMatrixLoc,!1,this.getTextureMatrix(e)),t.uniformMatrix4fv(this.modelViewMatrixLoc,!1,r.transform.getModelMatrix()),this},t.prototype.getTextureMatrix=function(t){var r=E.identity();E.translate(r,.5,.5,.5),E.scale(r,.5,.5,.5),E.mult(r,r,this.orthoProjectionMatrix);var e=[];return E.invert(e,t),E.mult(r,r,e),r},t.prototype.getLightWorldMatrix=function(t,r){return E.lookAt([t.transform.position.x,t.transform.position.y,t.transform.position.z],[r.transform.position.x,r.transform.position.y,r.transform.position.z],[0,1,0])},t}(),P=function(){function e(){}return e.createGeometry=function(i,o,n,a){return t(this,void 0,void 0,(function(){var t;return r(this,(function(r){switch(r.label){case 0:return t=M.bind,[4,e.createMesh(i,o,n,a)];case 1:return[2,new(t.apply(M,[void 0,r.sent()]))]}}))}))},e.createMesh=function(i,o,a,s){var u,c,h;return t(this,void 0,void 0,(function(){var t,l,f;return r(this,(function(r){switch(r.label){case 0:return[4,e.loadModel(i,a,s)];case 1:return t=r.sent(),l=t.vertices.vertexCount(),f={positions:new R(i,t.vertices.positions(),l,n.BUFFER_TYPE_VERTICES),normals:new R(i,t.vertices.normals(),l,n.BUFFER_TYPE_VERTICES),uvs:new R(i,t.vertices.uvs(),l,n.BUFFER_TYPE_VERTICES),texture:t.texture,drawMode:i.TRIANGLES,vertexCount:l},null===(u=f.positions)||void 0===u||u.bindToAttribute(o.positionLoc,n.DEFAULT_STRIDE,n.DEFAULT_OFFSET),null===(c=f.normals)||void 0===c||c.bindToAttribute(o.normalLoc,n.DEFAULT_STRIDE,n.DEFAULT_OFFSET),null===(h=f.uvs)||void 0===h||h.bindToAttribute(o.texCoordLoc,n.DEFAULT_STRIDE,n.DEFAULT_OFFSET),[2,f]}}))}))},e.loadModel=function(e,i,o){return t(this,void 0,void 0,(function(){var t,n,a,s,u;return r(this,(function(r){switch(r.label){case 0:return[4,A.loadOBJ(i)];case 1:return t=r.sent(),[4,x.loadTexture(e,o)];case 2:return n=r.sent(),[4,Promise.all([t,n])];case 3:return a=r.sent(),s=a[0],u=a[1],[2,{vertices:s,texture:u}]}}))}))},e}();const w=function(t,r){this.depthTexture=null,this.depthFramebuffer=null,this.depthTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.depthTexture),t.texImage2D(t.TEXTURE_2D,0,t.DEPTH_COMPONENT16,r,r,0,t.DEPTH_COMPONENT,t.UNSIGNED_INT,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),this.depthFramebuffer=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,this.depthFramebuffer),t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.TEXTURE_2D,this.depthTexture,0);var e=t.createTexture();t.bindTexture(t.TEXTURE_2D,e),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,r,r,0,t.RGBA,t.UNSIGNED_BYTE,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,e,0),this.depthTextureSize=r,this.gl=t};var U=function(){function t(t,r){var e=new g(t,"#version 300 es\n\t\t\tlayout(location=8) in vec3 a_position;\n\n\t\t\tuniform mat4 u_mVMatrix;\n\t\t\tuniform mat4 u_cameraViewMatrix;\n\t\t\tuniform mat4 u_oMatrix;\n\n\t\t\tmat4 m_worldMatrix;\n\t\t\tmat4 m_viewProjectionMatrix;\n\t\t\tmat4 m_worldViewProjectionMatrix;\n\n\t\t\tvoid main(void){\n\n\t\t\t\tm_worldMatrix = u_mVMatrix;\n\t\t\t\tm_viewProjectionMatrix = u_oMatrix * u_cameraViewMatrix;\n\t\t\t\tm_worldViewProjectionMatrix = m_viewProjectionMatrix * m_worldMatrix;\n\n\t\t\t\tgl_Position = m_worldViewProjectionMatrix * vec4(a_position, 1.0);\n\t\t\t}","#version 300 es\n\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\n\t\t\tout vec4 finalColor;\n\n\t\t\tvoid main(void) {\n\t\t\t\tfinalColor = u_color;\n\t\t\t}");e.activateShader(),this.positionLoc=t.getAttribLocation(e.program,n.ATTR_POSITION_NAME),this.modelViewMatrixLoc=t.getUniformLocation(e.program,n.UNI_MODEL_MAT),this.orthoMatrixLoc=t.getUniformLocation(e.program,n.UNI_ORTHO_MAT),this.cameraMatrixLoc=t.getUniformLocation(e.program,n.UNI_CAMERA_MAT),this.uColorLoc=t.getUniformLocation(e.program,n.UNI_COLOR),this.orthoProjectionMatrix=r.orthoProjection,this.viewModelMatrix=r.viewMatrix,this.shaderProgram=e,e.deactivateShader()}return t.prototype.setUniforms=function(t,r){return this.shaderProgram.activateShader(),t.uniformMatrix4fv(this.orthoMatrixLoc,!1,this.orthoProjectionMatrix),t.uniformMatrix4fv(this.cameraMatrixLoc,!1,this.viewModelMatrix),t.uniformMatrix4fv(this.modelViewMatrixLoc,!1,r.transform.getModelMatrix()),t.uniform4fv(this.uColorLoc,new Float32Array([0,0,0,1])),this},t}(),I=function(){function i(){}return i.createGeometry=function(e,o,n){return t(this,void 0,void 0,(function(){var t;return r(this,(function(r){switch(r.label){case 0:return t=M.bind,[4,i.createMesh(e,o,n)];case 1:return[2,new(t.apply(M,[void 0,r.sent()]))]}}))}))},i.createMesh=function(e,o,a){var s;return t(this,void 0,void 0,(function(){var t,u,c;return r(this,(function(r){switch(r.label){case 0:return[4,i.loadModel(e,a)];case 1:return t=r.sent(),u=t.vertices.vertexCount(),c={positions:new R(e,t.vertices.positions(),u,n.BUFFER_TYPE_VERTICES),depth:t.texture,drawMode:e.TRIANGLES,vertexCount:u},null===(s=c.positions)||void 0===s||s.bindToAttribute(o.positionLoc,n.DEFAULT_STRIDE,n.DEFAULT_OFFSET),[2,c]}}))}))},i.loadModel=function(i,o){return t(this,void 0,void 0,(function(){var t,n,a,s,u;return r(this,(function(r){switch(r.label){case 0:return[4,A.loadOBJ(o)];case 1:return t=r.sent(),n=new w(i,e.DEPTH_TEXTURE_SIZE),[4,Promise.all([t,n])];case 2:return a=r.sent(),s=a[0],u=a[1],[2,{vertices:s,texture:u}]}}))}))},i}();const F=function(){function t(t){this.lightPosition=t,this.specularFactor=1,this.lightColor=_({red:195,green:210,blue:190}),this.ambientLightColor=_({red:25.5,green:25.5,blue:25.5}),this.specularColor=_({red:195,green:210,blue:190}),this.shininess=500,this.specularFactor=1}return t.prototype.setUniforms=function(t,r,e){t.uniform3fv(r.lightPositionLoc,[this.lightPosition.x,this.lightPosition.y,this.lightPosition.z]),t.uniform4fv(r.lightColorLoc,this.lightColor),t.uniform4fv(r.ambientLightColorLoc,this.ambientLightColor),t.uniform4fv(r.specularColorLoc,this.specularColor),t.uniform3fv(r.cameraPositionLoc,e.transform.position.getFloatArray()),t.uniform1f(r.shininessLoc,this.shininess),t.uniform1f(r.specularFactorLoc,this.specularFactor)},t}();var y=function(){function t(t,r,e){var i=new g(t,"#version 300 es\n            layout(location=5) in vec3 a_position;\n\n\t\t\tuniform mat4 u_mVMatrix;\n\t\t\tuniform mat4 u_cameraViewMatrix;\n\t\t\tuniform mat4 u_pMatrix;\n\n\t\t\tvec3 unprojectPoint(float x, float y, float z, mat4 view, mat4 projection) {\n                mat4 viewInv = inverse(view);\n                mat4 projInv = inverse(projection);\n                vec4 unprojectedPoint =  viewInv * projInv * vec4(x, y, z, 1.0);\n                return unprojectedPoint.xyz / unprojectedPoint.w;\n            }\n\n\t\t\tout vec3 nearPoint;\n\t\t\tout vec3 farPoint;\n\t\t\tout mat4 fragView;\n            out mat4 fragProj;\n\n\t\t\tout vec3 vertexPosition;\n\n\t\t\tvoid main(void){\n\t\t\t\tvec3 p = a_position;\n\n\t\t\t\tfragView = u_cameraViewMatrix;\n                fragProj = u_pMatrix;\n\t\t\t\tnearPoint = unprojectPoint(p.x, p.y, 0.0, u_cameraViewMatrix, u_pMatrix).xyz;\n\t\t\t\tfarPoint = unprojectPoint(p.x, p.y, 1.0, u_cameraViewMatrix, u_pMatrix).xyz;\n\n\t\t\t\tvertexPosition = p.xyz;\n\t\t\t\tgl_Position = vec4(p, 1.0);\n\n\t\t\t}","#version 300 es\n\t\t\tprecision highp float;\n\n\t\t\tin vec3 vertexPosition;\n\t\t\tin vec3 nearPoint;\n            in vec3 farPoint;\n            in mat4 fragView;\n            in mat4 fragProj;\n\n\t\t\t// computes Z-buffer depth value, and converts the range.\n\t\t\tfloat computeDepth(vec3 pos) {\n\t\t\t\t// get the clip-space coordinates\n\t\t\t\tvec4 clip_space_pos = fragProj * fragView * vec4(pos.xyz, 1.0);\n\n\t\t\t\t// get the depth value in normalized device coordinates\n\t\t\t\tfloat clip_space_depth = clip_space_pos.z / clip_space_pos.w;\n\n\t\t\t\t// and compute the range based on gl_DepthRange settings (not necessary with default settings, but left for completeness)\n\t\t\t\tfloat far = gl_DepthRange.far;\n\t\t\t\tfloat near = gl_DepthRange.near;\n\n\t\t\t\tfloat depth = (((far-near) * clip_space_depth) + near + far) / 2.0;\n\n\t\t\t\t// and return the result\n\t\t\t\treturn depth;\n\t\t\t}\n\n\t\t\tfloat checkerboard(vec2 R, float scale) {\n\t\t\t\treturn float((\n\t\t\t\t\tint(floor(R.x / scale)) +\n\t\t\t\t\tint(floor(R.y / scale))\n\t\t\t\t) % 2);\n\t\t\t}\n\n            out vec4 finalColor;\n\n\t\t\tvoid main(void){\n\n                float t = -nearPoint.y / (farPoint.y - nearPoint.y);\n                vec3 fragPos3D = nearPoint + t * (farPoint - nearPoint);\n\t\n\t\t\t\tfloat isIntersect = (t > 0.0) ? 1.0 : 0.0;\n\t\t\t\tfloat gridPattern = (checkerboard(fragPos3D.xz, 1.0) * 0.3) + (checkerboard(fragPos3D.xz, 10.0) * 0.2) + (checkerboard(fragPos3D.xz, 100.0) * 0.1) + 0.1;\n\n\t\t\t\tfloat linearFieldSection = 0.02 * length(fragPos3D.xz);\n\t\t\t\tfloat fading = min(1.0, 1.5 - linearFieldSection);\n\n\t\t\t\tvec4 outColor = vec4(vec3((gridPattern/2.0) + 0.3), 1.0);\n\n\t\t\t\tfinalColor = outColor * isIntersect;\n\t\t\t\tfinalColor *= fading;\n\n\t\t\t\tgl_FragDepth = computeDepth(fragPos3D);\n            }");i.activateShader(),this.positionLoc=t.getAttribLocation(i.program,n.ATTR_POSITION_NAME),this.modelViewMatrixLoc=t.getUniformLocation(i.program,n.UNI_MODEL_MAT),this.perspectiveMatrixLoc=t.getUniformLocation(i.program,n.UNI_PERSPECTIV_MAT),this.cameraMatrixLoc=t.getUniformLocation(i.program,n.UNI_CAMERA_MAT),this.uColorLoc=t.getUniformLocation(i.program,n.UNI_COLOR),i.deactivateShader(),this.perspectiveProjectionMatrix=r.perspectiveProjection,this.orthoProjectionMatrix=r.orthoProjection,this.viewModelMatrix=r.viewMatrix,this.lightViewModelMatrix=e,this.shaderProgram=i}return t.prototype.setUniforms=function(t,r){return this.shaderProgram.activateShader(),t.uniformMatrix4fv(this.perspectiveMatrixLoc,!1,this.perspectiveProjectionMatrix),t.uniformMatrix4fv(this.cameraMatrixLoc,!1,this.viewModelMatrix),t.uniformMatrix4fv(this.modelViewMatrixLoc,!1,r.transform.getModelMatrix()),this},t}(),S=function(){function e(){}return e.createGeometry=function(i,o){return t(this,void 0,void 0,(function(){var t;return r(this,(function(r){switch(r.label){case 0:return t=M.bind,[4,e.createMesh(i,o)];case 1:return[2,new(t.apply(M,[void 0,r.sent()]))]}}))}))},e.createMesh=function(e,i){var o;return t(this,void 0,void 0,(function(){var t,a,s,u;return r(this,(function(r){return a=(t=[1,-1,0,1,1,0,-1,-1,0,-1,1,0,-1,-1,0,1,1,0]).length/3,s=3*Float32Array.BYTES_PER_ELEMENT,u={positions:new R(e,t,a,n.BUFFER_TYPE_VERTICES),drawMode:e.TRIANGLES,vertexCount:a},null===(o=u.positions)||void 0===o||o.bindToAttribute(i.positionLoc,s,n.DEFAULT_OFFSET,n.GRID_VECTOR_SIZE),[2,u]}))}))},e}();t(void 0,void 0,void 0,(function(){var t,i,o,n,a,s,u,c,h,l,f,_,E;return r(this,(function(r){switch(r.label){case 0:return(t=new p(e.WEBGL_CANVAS_ID)).fitScreen(.95,.9).setClearColor(13,17,23,1).clear(),i=t.getContext(),o=new m(1.5,2.5,3),n=new F(o),(a=new d(i)).transform.position.set(o.x,o.y,o.z),s=new U(i,a),[4,I.createGeometry(i,s,e.PATH_ASSETS_OBJ)];case 1:return u=r.sent(),(c=new d(i)).transform.position.set(0,.5,1.5),new T(i,c),h=new y(i,c,a),[4,S.createGeometry(i,h)];case 2:return l=r.sent(),f=new L(i,c,a),[4,P.createGeometry(i,f,e.PATH_ASSETS_OBJ,e.PATH_ASSETS_TEXTURE)];case 3:return(_=r.sent()).setScale(.0035,.0035,.0035).setRotation(0,30,0),(E=function(){t.depthRender(u.mesh.depth),a.updateViewMatrix(),s.setUniforms(i,u.preRender()).shaderProgram.renderModel(u.preRender()),t.clearFramebuffer().fitScreen(.95,.9).clear(),c.updateViewMatrix(),h.setUniforms(i,l.preRender()).shaderProgram.renderModel(l.preRender()),f.setUniforms(i,_.preRender()).shaderProgram.renderModel(_.preRender()),n.setUniforms(i,f,c),requestAnimationFrame(E)})(),[2]}}))}))})();
//# sourceMappingURL=bundle.js.map